<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DroneFlight Planner</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.111/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.111/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        body, html { height: 100%; margin: 0; padding: 0; }
        #cesiumContainer { width: 100%; height: 90%; display: block; }
        #controls { padding: 8px; }
    </style>
</head>
<body>
<div id="controls">
    <input type="file" id="kmzInput">
    <button id="uploadBtn">Upload KMZ</button>
    <label for="widthInput">Corridor width (m):</label>
    <input type="number" id="widthInput" value="10" min="0" step="1" style="width:60px;" />
    <button id="startDraw">Start new line</button>
    <button id="finishDraw">Finish line</button>
    <button id="clearDrawings">Clear drawings</button>
</div>
<div id="cesiumContainer"></div>
<script>
    const viewer = new Cesium.Viewer('cesiumContainer', {
        terrainProvider: Cesium.createWorldTerrain()
    });

    // drawing state
    let drawing = false;
    let currentPositions = [];
    let currentEntity = null;

    const handler = new Cesium.ScreenSpaceEventHandler(viewer.canvas);
    handler.setInputAction(function(click) {
        if (!drawing) return;
        const cartesian = viewer.camera.pickEllipsoid(click.position, viewer.scene.globe.ellipsoid);
        if (cartesian) {
            currentPositions.push(cartesian);
            if (!currentEntity) {
                currentEntity = viewer.entities.add({
                    polyline: {
                        positions: new Cesium.CallbackProperty(function() { return currentPositions; }, false),
                        width: 4,
                        material: Cesium.Color.BLUE
                    }
                });
            }
        }
    }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

    document.getElementById('startDraw').addEventListener('click', () => {
        drawing = true;
        currentPositions = [];
        if (currentEntity) {
            viewer.entities.remove(currentEntity);
            currentEntity = null;
        }
    });
    document.getElementById('finishDraw').addEventListener('click', () => {
        drawing = false;
    });
    document.getElementById('clearDrawings').addEventListener('click', () => {
        drawing = false;
        currentPositions = [];
        if (currentEntity) {
            viewer.entities.remove(currentEntity);
            currentEntity = null;
        }
    });

    document.getElementById('uploadBtn').addEventListener('click', () => {
        const fileInput = document.getElementById('kmzInput');
        if (!fileInput.files.length) return;
        const file = fileInput.files[0];
        const width = parseFloat(document.getElementById('widthInput').value) || 0;

        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const arrayBuffer = e.target.result;
                const zip = await JSZip.loadAsync(arrayBuffer);
                const kmlFiles = Object.keys(zip.files).filter(n => n.toLowerCase().endsWith('.kml'));
                if (!kmlFiles.length) {
                    alert('No KML files found inside KMZ');
                    return;
                }

                const groups = [];
                for (const name of kmlFiles) {
                    const text = await zip.file(name).async('string');
                    const re = /<coordinates>([^<]+)<\/coordinates>/g;
                    let m;
                    while ((m = re.exec(text)) !== null) {
                        const coordsText = m[1].trim();
                        const parts = coordsText.split(/\s+/);
                        const flat = [];
                        for (const p of parts) {
                            const comps = p.split(',');
                            if (comps.length >= 2) {
                                flat.push(parseFloat(comps[0]));
                                flat.push(parseFloat(comps[1]));
                            }
                        }
                        if (flat.length >= 4) groups.push(flat);
                    }
                }

                if (!groups.length) {
                    alert('No coordinates found in KML files');
                    return;
                }

                let firstEntity = null;
                groups.forEach((coordsArr) => {
                    const e = viewer.entities.add({
                        corridor: {
                            positions: Cesium.Cartesian3.fromDegreesArray(coordsArr),
                            width: width,
                            material: Cesium.Color.RED.withAlpha(0.8),
                            height: 0,
                            extrudedHeight: 5.0
                        }
                    });
                    if (!firstEntity) firstEntity = e;
                });
                if (firstEntity) viewer.zoomTo(firstEntity);

                if (firstEntity) {
                    const coords = groups[0];
                    const property = new Cesium.SampledPositionProperty();
                    for (let i = 0; i < coords.length; i += 2) {
                        const lon = coords[i];
                        const lat = coords[i+1];
                        const time = Cesium.JulianDate.addSeconds(Cesium.JulianDate.now(), i, new Cesium.JulianDate());
                        property.addSample(time, Cesium.Cartesian3.fromDegrees(lon, lat));
                    }
                    viewer.entities.add({ position: property, point: { pixelSize: 10, color: Cesium.Color.BLUE } });
                    viewer.clock.startTime = Cesium.JulianDate.now();
                    viewer.clock.stopTime = Cesium.JulianDate.addSeconds(viewer.clock.startTime, groups[0].length/2, new Cesium.JulianDate());
                    viewer.clock.currentTime = viewer.clock.startTime;
                    viewer.clock.multiplier = 1;
                    viewer.clock.shouldAnimate = true;
                }
            } catch (err) {
                alert('Failed to parse KMZ client-side: ' + err);
            }
        };
        reader.readAsArrayBuffer(file);
    });

    // load JSZip from CDN
    (function loadJSZip(){
        if (window.JSZip) return;
        const s = document.createElement('script');
        s.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js';
        s.onload = ()=>console.log('JSZip loaded');
        document.head.appendChild(s);
    })();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KMZ Viewer</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map {
            width: 100%;
            height: 500px;
        }
    </style>
</head>
<body>
    <h1>Upload KMZ File</h1>
    <input type="file" id="fileInput" accept=".kmz" />
    <button id="uploadButton">Upload</button>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/@tmcw/togeojson@2.0.1/togeojson.js"></script>
    
    <script>
        let map;

        // Initialize the map
        function initMap() {
            map = L.map('map').setView([0, 0], 2); // Center map at coordinates 0,0
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
            }).addTo(map);
        }

        document.getElementById('uploadButton').addEventListener('click', function() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a KMZ file.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                const kmzData = event.target.result;
                parseKMZ(kmzData);
            };
            reader.readAsArrayBuffer(file);
        });

        function parseKMZ(kmzData) {
            JSZip.loadAsync(kmzData).then(zip => {
                // Find the KML file inside the KMZ
                const kmlFileName = Object.keys(zip.files).find(name => name.endsWith('.kml'));

                if (!kmlFileName) {
                    alert('No KML file found in the KMZ.');
                    return;
                }

                // Read the KML file
                zip.file(kmlFileName).async('text').then(kmlText => {
                    // Parse the KML using the KML parser
                    const parser = new DOMParser();
                    const kmlDoc = parser.parseFromString(kmlText, 'text/xml');
                    const geoJson = toGeoJSON.kml(kmlDoc);
                    
                    // Add GeoJSON data to the map
                    L.geoJSON(geoJson, {
                        onEachFeature: function (feature, layer) {
                            layer.bindPopup(feature.properties.name || 'No Name');
                        }
                    }).addTo(map);
                    map.fitBounds(L.geoJSON(geoJson).getBounds());
                }).catch(err => {
                    console.error('Error reading KML file:', err);
                    alert('Error reading KML file.');
                });
            }).catch(err => {
                console.error('Error loading KMZ file:', err);
                alert('Error loading KMZ file.');
            });
        }

        // Initialize the map on page load
        window.onload = initMap;
    </script>
</body>
</html>